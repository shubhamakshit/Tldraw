<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon-96x96.png?v=2" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Color-RM" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ColorRM Pro: Ultimate + Box</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    
    <style>
        :root {
            --bg-body: #000000; --bg-panel: #000000; --bg-surface: #111111;
            --primary: #ffffff; --accent: #0070f3; --text-main: #ffffff; --text-muted: #888888;
            --text: var(--text-main);
            --border: #333333; --glass: rgba(0, 0, 0, 0.9);
            --menu-bg: #000000;
            --success: #0070f3;
        }
        * { box-sizing: border-box; outline: none; }
        body {
            height: 100dvh; width: 100vw; margin: 0; padding: 0;
            background-color: var(--bg-body); color: var(--text-main);
            font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; display: flex; flex-direction: column; user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        /* UI Components - Vercel Style */
        .btn {
            background: #0a0a0a; border: 1px solid #262626; color: #fafafa;
            padding: 10px 14px; border-radius: 8px; font-size: 0.875rem; font-weight: 500;
            cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.15s;
            min-height: 40px;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:hover { background: #171717; border-color: #333; }
        .btn:active { transform: scale(0.98); background: #1a1a1a; }
        .btn.active { background: #fafafa; border-color: #fafafa; color: #000; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-primary { background: #fafafa; border-color: #fafafa; color: #000; font-weight: 600; }
        .btn-primary:hover { background: #e5e5e5; border-color: #e5e5e5; }
        .btn-primary:active { background: #d4d4d4; transform: scale(0.98); }
        .btn-sm { padding: 6px 10px; font-size: 0.8rem; min-height: 32px; border-radius: 6px; }
        .btn-icon { width: 36px; height: 36px; justify-content: center; padding: 0; min-height: 36px; }

        /* Sidebar Tabs - Touch Optimized */
        .sb-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg-panel); flex-shrink: 0; overflow-x: auto; overflow-y: hidden; scrollbar-width: none; -ms-overflow-style: none; }
        .sb-tabs::-webkit-scrollbar { display: none; }
        .sb-tab { flex: 1 0 auto; min-width: 80px; padding: 16px 12px; text-align: center; cursor: pointer; color: var(--text-muted); font-size: 0.8rem; border-bottom: 2px solid transparent; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; transition: 0.15s; white-space: nowrap; -webkit-tap-highlight-color: transparent; }
        .sb-tab:hover { color: white; background: rgba(255,255,255,0.03); }
        .sb-tab:active { background: rgba(255,255,255,0.08); }
        .sb-tab.active { color: white; border-bottom-color: white; }

        /* Context Toolbar - Touch Optimized */
        .context-toolbar {
            position: absolute; background: var(--menu-bg); padding: 4px 8px; border-radius: 24px;
            display: none; gap: 2px; align-items: center; z-index: 100;
            box-shadow: 0 0 0 1px #333, 0 4px 20px rgba(0,0,0,0.5); border: none;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        .ctx-btn { background: none; border: none; color: #888; font-size: 1rem; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.15s; min-width: 36px; min-height: 36px; -webkit-tap-highlight-color: transparent; position: relative; }
        .ctx-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .ctx-btn:active { background: rgba(255,255,255,0.15); transform: scale(0.95); }
        .ctx-btn.delete { color: #888; }
        .ctx-btn.delete:hover { color: #ff4d4d; }
        .ctx-btn .color-indicator { position: absolute; bottom: 4px; right: 4px; width: 8px; height: 8px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3); }
        .ctx-divider { width: 1px; height: 16px; background: #444; margin: 0 2px; }

        /* Dropdown Menu - Touch Optimized */
        .ctx-dropdown {
            position: absolute; top: 100%; right: 0; margin-top: 8px;
            background: var(--menu-bg); border: 1px solid #333; border-radius: 8px;
            width: 200px; padding: 6px; display: none; flex-direction: column; gap: 2px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        .ctx-dropdown.show { display: flex; }
        .ctx-row { display: flex; gap: 12px; align-items: center; padding: 12px 14px; border-radius: 6px; cursor: pointer; font-size: 0.875rem; color: #888; transition: 0.15s; min-height: 44px; -webkit-tap-highlight-color: transparent; }
        .ctx-row:hover { background: #111; color: white; }
        .ctx-row:active { background: #1a1a1a; }
        
        /* Switches - Touch Optimized */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-switch { position: absolute; cursor: pointer; inset: 0; background-color: #000; border: 1px solid #444; transition: .2s; border-radius: 24px; }
        .slider-switch:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: #888; transition: .2s; border-radius: 50%; }
        input:checked + .slider-switch { background-color: #fff; border-color: #fff; }
        input:checked + .slider-switch:before { transform: translateX(20px); background-color: #000; }

        /* Tool Buttons - Touch Optimized */
        .tool-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .tool-btn { flex: 1; justify-content: center; flex-direction: column; gap: 6px; padding: 12px 8px; min-height: 64px; font-size: 0.75rem; border-radius: 8px; border-color: #333; -webkit-tap-highlight-color: transparent; }
        .tool-btn:active { transform: scale(0.96); }
        .tool-btn i { font-size: 1.25rem; }

        /* Color Dots - Touch Optimized */
        .color-dot { width: 32px; height: 32px; border-radius: 6px; border: 2px solid #333; cursor: pointer; transition: 0.15s; -webkit-tap-highlight-color: transparent; }
        .color-dot:active { transform: scale(0.9); }

        /* Canvas & Viewport */
        .viewport { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; touch-action: none; }
        canvas { max-width: 98%; max-height: 98%; box-shadow: 0 0 0 1px #222; background-color: #000; }

        /* Infinite Canvas Mode - seamless fullscreen display */
        .viewport.infinite-canvas-mode { align-items: stretch; justify-content: stretch; }
        .viewport.infinite-canvas-mode canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            width: 100% !important;
            height: 100% !important;
            box-shadow: none;
        }

        /* Split View */
        .split-view-container { display: flex; flex-direction: column; flex: 1; overflow: hidden; background: var(--border); position: relative; }
        .split-view-container > div:first-child { display: flex; flex: 1; overflow: hidden; gap: 1px; }
        .split-view-panel { flex: 1; background: #000; display: flex; flex-direction: column; overflow: hidden; position: relative; min-width: 0; }
        .split-view-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-surface); border-bottom: 1px solid var(--border); flex-shrink: 0; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .split-view-canvas-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; overflow: auto; position: relative; background: #000; }
        #rightPdfCanvas { display: block; position: relative; }
        #rightDrawCanvas { display: block; position: absolute; top: 0; left: 0; pointer-events: auto; }
        .split-view-footer { display: flex; justify-content: center; align-items: center; padding: 8px 12px; background: var(--bg-surface); border-top: 1px solid var(--border); flex-shrink: 0; gap: 8px; font-size: 0.8rem; color: var(--text-muted); flex-wrap: wrap; }
        .split-view-active .viewport { display: none; }
        .split-view-active .workspace { display: flex; }
        
        /* Shape Grid - Touch Optimized */
        .shape-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 10px; }
        .shape-btn { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 6px; cursor: pointer; border: 1px solid #333; transition: 0.15s; color: #888; min-width: 40px; min-height: 40px; -webkit-tap-highlight-color: transparent; }
        .shape-btn:hover { border-color: #666; color: #fff; }
        .shape-btn:active { transform: scale(0.92); background: #111; }
        .shape-btn.active { background: #fff; color: #000; border-color: #fff; }

        header { height: 52px; background: #000; border-bottom: 1px solid #1a1a1a; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 50; flex-shrink: 0; }
        
        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* Sidebar Base */
        .sidebar { 
            width: 280px; 
            background: var(--bg-panel); 
            border-left: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            z-index: 40; 
            height: 100%; 
            position: relative;
            min-width: 200px;
            max-width: 60vw;
        }

        .sidebar-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
        }

        .sb-page-grid, .box-grid { overflow-x: auto; padding-bottom: 8px; min-width: 0; -webkit-overflow-scrolling: touch; }
        .sb-page-item, .box-item { flex-shrink: 0; min-width: 70px; min-height: 70px; }
        .sb-page-grid, .sb-page-list { min-width: 100%; }

        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); display: grid; gap: 10px; background: #000; flex-shrink: 0; }
        .control-section { display: flex; flex-direction: column; gap: 14px; }
        .control-section h4 { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin: 0; letter-spacing: 0.1em; font-weight: 700; }
        
        /* Bookmarks - Touch Optimized */
        .bm-list { display: flex; flex-direction: column; gap: 6px; }
        .bm-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: transparent; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: 0.15s; border: 1px solid #222; color: #888; min-height: 44px; -webkit-tap-highlight-color: transparent; }
        .bm-item:hover { background: #111; border-color: #444; color: #fff; }
        .bm-item:active { background: #1a1a1a; }
        .bm-del { color: #555; background: none; border: none; cursor: pointer; padding: 8px; transition: 0.15s; min-width: 36px; min-height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .bm-del:hover { color: #ff4d4d; background: rgba(255,77,77,0.1); }

        /* Sidebar Page Preview Grid - Touch Optimized */
        .sb-page-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .sb-page-item { aspect-ratio: 1; background: #000; border-radius: 6px; cursor: pointer; position: relative; border: 2px solid #222; overflow: hidden; transition: 0.15s; -webkit-tap-highlight-color: transparent; }
        .sb-page-item:active { transform: scale(0.97); }
        .sb-page-item.active { border-color: white; }
        .sb-page-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; transition: 0.15s; }
        .sb-page-item:hover img { opacity: 1; }
        .sb-page-num { position: absolute; bottom: 6px; right: 6px; background: rgba(0,0,0,0.85); font-size: 0.7rem; padding: 4px 6px; border-radius: 4px; color: #fff; border: 1px solid #333; font-weight: 600; }

        /* Box / Clipboard Grid - Touch Optimized */
        .box-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .box-item { position: relative; border: 2px solid #222; border-radius: 6px; overflow: hidden; background: #000; transition: 0.15s; -webkit-tap-highlight-color: transparent; }
        .box-item:hover { border-color: #444; }
        .box-item:active { transform: scale(0.97); }
        .box-item img { width: 100%; height: auto; display: block; }
        .box-del { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.85); color: #fff; border: 1px solid #333; border-radius: 6px; padding: 8px; cursor: pointer; opacity: 0; transition: 0.15s; min-width: 32px; min-height: 32px; display: flex; align-items: center; justify-content: center; }
        .box-item:hover .box-del { opacity: 1; }
        .toast { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 0.875rem; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 150; box-shadow: 0 8px 30px rgba(0,0,0,0.5); }
        .toast.show { opacity: 1; top: 80px; }

        /* Floating Picker */
        #floatingPicker { position: absolute; top: 80px; left: 50px; width: 240px; background: #000; border: 1px solid #333; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 100; overflow: hidden; }
        .picker-header { padding: 12px; background: #111; border-bottom: 1px solid #333; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .picker-body { padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 16px; }

        /* Modals - Vercel Style */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 200; display: none; place-items: center; }
        .card { background: #000; padding: 24px; border-radius: 12px; border: 1px solid #1a1a1a; max-width: 440px; width: 90%; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 16px 70px rgba(0,0,0,0.5); }

        /* Loader Style */
        .spinner { width: 32px; height: 32px; border: 2px solid #333; border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spin { animation: spin 0.8s linear infinite; display: inline-block; }

        /* Enhanced Loading States */
        .skeleton {
            background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Loading overlay for buttons */
        .btn.loading {
            position: relative;
            pointer-events: none;
            color: transparent;
        }
        .btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        .btn-primary.loading::after {
            border-top-color: #000;
        }

        /* Pulse animation for sync status */
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Fade-in animation for loaded content */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Swatches - Touch Optimized */
        .swatch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 8px; }
        .swatch { width: 36px; height: 36px; border-radius: 6px; cursor: pointer; border: 2px solid #333; transition: 0.15s; -webkit-tap-highlight-color: transparent; }
        .swatch:hover { transform: scale(1.08); border-color: #fff; }
        .swatch:active { transform: scale(0.95); }

        /* Slider - Touch Optimized */
        .slider { -webkit-appearance: none; width: 100%; height: 6px; background: #333; border-radius: 4px; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; height: 22px; width: 22px; border-radius: 50%; background: #fff; cursor: pointer; border: 3px solid #000; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }

        /* Export Modal Styles */
        .tab-btn { flex: 1; padding: 10px; background: transparent; border: none; border-bottom: 2px solid transparent; color: #888; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s; }
        .tab-btn.active { color: white; border-bottom-color: white; }
        .thumb-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; overflow-y: auto; max-height: 300px; margin-top: 10px; padding: 8px; background: #0a0a0a; border: 1px solid #222; border-radius: 4px; }
        .thumb-item { aspect-ratio: 1; background: #000; border: 1px solid #333; border-radius: 4px; position: relative; cursor: pointer; overflow: hidden; }
        .thumb-item.selected { border-color: #fff; }
        .thumb-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; }
        .thumb-item.selected img { opacity: 1; }
        .thumb-item span { position: absolute; bottom: 0; right: 0; background: #fff; color: #000; font-size: 0.6rem; padding: 2px 4px; font-weight: 800; }
        
        .tag-pill { background: #111; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-family: monospace; color: #888; cursor: pointer; border: 1px solid #333; transition: 0.2s; }
        .tag-pill:hover { border-color: #fff; color: #fff; }

        .owner-badge { font-size: 0.6rem; padding: 2px 4px; border-radius: 2px; background: #fff; color: #000; font-weight: 800; text-transform: uppercase; margin-left: 8px; }
        .other-badge { font-size: 0.6rem; padding: 2px 4px; border-radius: 2px; background: #333; color: #fff; font-weight: 800; text-transform: uppercase; margin-left: 8px; }

        .opt-row { display: flex; gap: 8px; align-items: center; }
        .opt-input { background: #000; border: 1px solid #333; color: white; padding: 8px 12px; border-radius: 4px; font-size: 0.8rem; outline: none; }
        .opt-input:focus { border-color: #fff; }

        /* Session List - Vercel Style */
        .session-item {
            position: relative;
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s;
        }
        .session-item:hover {
            background: #111;
            border-color: #262626;
        }
        .session-item .session-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: #fafafa;
        }
        .session-item .session-meta {
            font-size: 0.75rem;
            color: #666;
            margin-top: 4px;
        }
        .session-checkbox { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; cursor: pointer; display: none; accent-color: var(--accent); border: 1px solid #444; border-radius: 4px; }
        .active-multi .session-checkbox { display: block; }
        .session-item.selected { background: rgba(0, 112, 243, 0.08); border-color: #0070f3; }
        .active-multi .session-item { padding-left: 44px; }
        .multi-delete-bar { display: none; justify-content: space-between; align-items: center; background: #0a0a0a; border: 1px solid #262626; padding: 12px 16px; border-radius: 8px; }
        .multi-delete-bar.show { display: flex; }

        /* Remote Cursors */
        .cursor-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; overflow: hidden; }
        .remote-cursor { position: absolute; display: flex; flex-direction: column; align-items: flex-start; transition: transform 0.1s linear; pointer-events: none; z-index: 100; }
        .cursor-pointer { width: 12px; height: 12px; border: 2px solid white; border-radius: 50% 50% 50% 0; background: #0070f3; transform: rotate(-15deg); }
        .cursor-label { background: #fff; color: #000; padding: 2px 6px; border-radius: 2px; font-size: 0.6rem; font-weight: 800; margin-top: 4px; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.05em; }

        /* User List */
        .user-item { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: #888; background: #0a0a0a; padding: 8px 12px; border-radius: 4px; border: 1px solid #222; }
        .user-item.self { border-color: #fff; color: #fff; }
        .user-dot { width: 6px; height: 6px; border-radius: 50%; }

        /* Navigation Island - Touch Optimized */
        .nav-island { position:absolute; bottom:24px; left:50%; transform:translateX(-50%); background:#000; padding:8px 16px; border-radius:12px; border:1px solid #333; display:flex; gap:8px; align-items:center; box-shadow:0 8px 30px rgba(0,0,0,0.5); }

        /* --- Resizer Styles - Touch Optimized --- */
        /* Desktop: Resizer on the Right Edge */
        .resize-handle-side {
            position: absolute;
            top: 0;
            right: 0;
            width: 20px;
            height: 100%;
            cursor: col-resize;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            transition: background 0.15s;
            -webkit-tap-highlight-color: transparent;
        }

        .resize-handle-side:hover,
        .resize-handle-side:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .resize-handle-side::after {
            content: "⋮";
            color: #555;
            font-size: 16px;
            font-weight: bold;
            pointer-events: none;
        }

        /* Mobile: Resizer on the Top Edge (because sidebar is at bottom) */
        .resize-handle-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 28px;
            cursor: row-resize;
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            border-top: 1px solid var(--border);
            -webkit-tap-highlight-color: transparent;
        }

        .resize-handle-top:active {
            background: rgba(255, 255, 255, 0.05);
        }

        .resize-handle-top::after {
            content: "⬍";
            color: #666;
            font-size: 16px;
            pointer-events: none;
        }

        /* Mobile Responsive - Touch Optimized */
        @media (max-width: 900px) {
            .workspace { flex-direction: column-reverse; }
            .sidebar {
                width: 100% !important;
                height: 40vh;
                min-height: 25vh;
                max-height: 70vh;
                border-left: none;
                border-top: none;
                min-width: 100%;
            }
            .resize-handle-side {
                display: none;
            }
            .resize-handle-top {
                display: flex;
            }
            .viewport { height: auto; flex: 1; }

            /* Mobile: Larger touch targets */
            .tool-btn { min-height: 58px; }
            .btn-icon { width: 44px; height: 44px; }
            .nav-island { padding: 10px 16px; gap: 6px; bottom: 16px; }
            .sidebar-content { padding: 16px; gap: 16px; }
            header { padding: 0 12px; height: 52px; }

            /* Mobile: Compact tool rows */
            .tool-row { gap: 6px; margin-bottom: 6px; }
        }

        /* Tablet Landscape */
        @media (max-width: 900px) and (orientation: landscape) {
            .sidebar {
                height: 50vh;
                min-height: 35vh;
                max-height: 60vh;
            }
            .resize-handle-top { height: 24px; }
            header { height: 48px; }
        }

        /* Small Mobile */
        @media (max-width: 480px) {
            .sidebar {
                height: 45vh;
                min-height: 30vh;
            }
            header { padding: 0 10px; }
            .btn { padding: 8px 10px; font-size: 0.8rem; }
            .sb-tab { padding: 14px 8px; font-size: 0.7rem; min-width: 60px; }
            .tool-btn { font-size: 0.65rem; min-height: 54px; }
            .nav-island { padding: 8px 12px; gap: 4px; bottom: 12px; border-radius: 10px; }
        }

        /* Hide Input Number Spinner */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Add Page Modal Styles */
        .page-modal-tab {
            background: transparent;
            color: #888;
        }
        .page-modal-tab.active {
            background: var(--primary);
            color: white;
        }
        .page-modal-tab:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .size-preset-btn {
            padding: 12px 8px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .size-preset-btn:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        .size-preset-btn.active {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }

        .color-preset {
            width: 28px;
            height: 28px;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s;
        }
        .color-preset:hover {
            transform: scale(1.1);
            border-color: #8b5cf6;
        }

        .insert-pos-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .insert-pos-btn:hover {
            border-color: #8b5cf6;
        }
        .insert-pos-btn.active {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }

        /* Template tab insert position buttons */
        .insert-pos-btn-template, .insert-pos-btn-infinite {
            flex: 1;
            padding: 12px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .insert-pos-btn-template:hover, .insert-pos-btn-infinite:hover {
            border-color: #8b5cf6;
        }
        .insert-pos-btn-template.active, .insert-pos-btn-infinite.active {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }

        .template-btn {
            padding: 0;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }
        .template-btn:hover {
            border-color: #8b5cf6;
            transform: translateY(-2px);
        }
        .template-preview {
            width: 100%;
            height: 80px;
            border-radius: 10px 10px 0 0;
        }
        .template-label {
            padding: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <script>
        // --- NATIVE BRIDGE BUFFER ---
        // Buffers intents from Android Native before the main app loads
        if (!window.handleSharedFile) {
            window.handleSharedFile = function(uri) {
                console.log('Buffer: shared file', uri);
                window.pendingFileUri = uri;
            };
        }
        if (!window.handleSharedUrl) {
            window.handleSharedUrl = function(url) {
                console.log('Buffer: shared url', url);
                window.pendingUrl = url;
            };
        }
    </script>

    <!-- Toast -->
    <div id="toast" class="toast">Added to Box!</div>

    <!-- Loader -->
    <div id="loader" class="overlay" style="z-index:300">
        <div class="card" style="text-align:center; height:auto;">
            <div class="spinner"></div>
            <h3 id="loadText" style="margin:10px 0;">Processing...</h3>
            <div style="width:100%; height:6px; background:#333; border-radius:3px; overflow:hidden; margin-top:5px;">
                <div id="progBar" style="width:0%; height:100%; background:var(--primary); transition:width 0.1s;"></div>
            </div>
            <div id="progDetail" style="font-size:0.8rem; color:#888; margin-top:5px;"></div>
        </div>
    </div>

    <!-- Input Modal -->
    <div id="inputModal" class="overlay" style="z-index:250">
        <div class="card" style="max-width:320px;">
            <h3 id="inputTitle" style="margin:0 0 15px 0">Input</h3>
            <input type="text" id="inputField" class="form-control" style="background:var(--bg-body); border:1px solid var(--border); color:white; padding:10px; border-radius:6px; width:100%; margin-bottom:15px;" autocomplete="off">
            <div style="display:flex; justify-content:flex-end; gap:8px;">
                <button class="btn" onclick="document.getElementById('inputModal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" id="inputConfirmBtn">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Move Modal -->
    <div id="moveModal" class="overlay" style="z-index:260">
        <div class="card" style="max-width:350px;">
            <h3 style="margin:0 0 15px 0">Move Projects</h3>
            <p style="font-size:0.8rem; color:#aaa; margin-top:0;">Select destination folder:</p>
            <select id="moveFolderSelect" class="opt-input" style="width:100%; margin-bottom:20px;"></select>
            <div style="display:flex; justify-content:flex-end; gap:8px;">
                <button class="btn" onclick="document.getElementById('moveModal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" id="moveConfirmBtn">Move</button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard - Vercel-like Clean Design -->
    <div id="dashboardModal" class="overlay">
        <div class="card" style="max-width: 520px; padding: 0; overflow: hidden;">
            <!-- Header -->
            <div style="padding: 24px 24px 20px; border-bottom: 1px solid #1a1a1a;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <svg width="24" height="24" viewBox="0 0 76 65" fill="#fff"><path d="M37.5274 0L75.0548 65H0L37.5274 0Z"></path></svg>
                        <span style="font-size: 1.1rem; font-weight: 600; letter-spacing: -0.02em;">Projects</span>
                    </div>
                    <button onclick="UI.hideDashboard()" style="background: none; border: none; color: #666; cursor: pointer; padding: 8px; border-radius: 6px; transition: 0.15s;" onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='none'">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Create New -->
            <div style="padding: 20px 24px; border-bottom: 1px solid #1a1a1a;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newProjectName" placeholder="Project name..." style="flex: 1; background: #0a0a0a; border: 1px solid #262626; padding: 12px 14px; color: white; border-radius: 8px; font-size: 0.9rem; transition: border-color 0.15s;" onfocus="this.style.borderColor='#404040'" onblur="this.style.borderColor='#262626'">
                    <button class="btn btn-primary" onclick="window.App.createNewProject()" style="padding: 12px 20px; border-radius: 8px; font-weight: 600;">Create</button>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button id="importBtn" class="btn" style="flex: 1; justify-content: center; background: #0a0a0a; border-color: #262626; font-size: 0.85rem; padding: 10px;">
                        <i class="bi bi-plus-lg"></i> Import
                    </button>
                    <button class="btn" onclick="window.App.createFolder()" style="background: #0a0a0a; border-color: #262626; padding: 10px 14px;" title="New Folder">
                        <i class="bi bi-folder-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Project List -->
            <div style="padding: 16px 24px 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.75rem; color: #666; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">Recent</span>
                    <button id="dashEditBtn" class="btn btn-sm" onclick="window.App.toggleMultiSelect()" style="background: transparent; border: none; color: #666; padding: 4px 8px; font-size: 0.75rem;">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>
            </div>

            <div id="sessionList" class="session-list" style="flex: 1; overflow: auto; min-height: 240px; max-height: 360px; padding: 0 24px 24px;"></div>

            <!-- Multi-select Bar -->
            <div id="multiDeleteBar" class="multi-delete-bar" style="margin: 0 24px 24px; border-radius: 8px; background: #0a0a0a;">
                <span id="multiDeleteCount" style="font-size: 0.8rem; color: #888; font-weight: 500;">0 selected</span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-sm" onclick="window.App.selectAllSessions()" style="background: transparent; border-color: #333; color: #888;">All</button>
                    <button class="btn btn-sm" onclick="window.App.showMoveModal()" style="background: transparent; border-color: #333; color: #888;">Move</button>
                    <button class="btn btn-sm" onclick="window.App.deleteSelectedSessions()" style="background: #dc2626; border-color: #dc2626; color: white;">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="overlay">
        <div class="card" style="width:500px; max-height: 95vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0">Export PDF</h3>
                <button onclick="document.getElementById('exportModal').style.display='none'" style="background:none; border:none; color:#aaa; cursor:pointer;"><i class="bi bi-x-lg"></i></button>
            </div>
            <div style="display:flex; border-bottom:1px solid var(--border);">
                <button class="tab-btn active" id="tabRange" onclick="App.setDlTab('range')">Range</button>
                <button class="tab-btn" id="tabSelect" onclick="App.setDlTab('select')">Thumbnails</button>
                <button class="tab-btn" id="tabOpts" onclick="App.setDlTab('opts')">Header/Footer</button>
            </div>
            
            <div id="dlPanelRange" style="padding:15px 0;">
                <p style="font-size:0.9rem; color:#aaa; margin-top:0;">Enter pages (e.g. 1, 3-5, 8). Leave empty for all.</p>
                <input type="text" id="dlRangeInput" placeholder="All Pages" style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:white; padding:10px; border-radius:6px;">
            </div>

            <div id="dlPanelSelect" style="display:none; padding:10px 0;">
                <div style="display:flex; gap:10px; margin-bottom:5px;">
                    <button class="btn btn-sm" onclick="App.dlSelectAll(true)">Select All</button>
                    <button class="btn btn-sm" onclick="App.dlSelectAll(false)">Deselect All</button>
                </div>
                <div id="dlThumbGrid" class="thumb-grid"></div>
            </div>

            <div id="dlPanelOpts" style="display:none; padding:10px 0;">
                <p style="font-size:0.8rem; color:#aaa; margin:0 0 10px 0;">Available Tags: <span class="tag-pill" onclick="App.addTag('{seq}')">{seq}</span> <span class="tag-pill" onclick="App.addTag('{date}')">{date}</span> <span class="tag-pill" onclick="App.addTag('{page}')">{page}</span> <span class="tag-pill" onclick="App.addTag('{day}')">{day}</span></p>
                
                <div style="margin-bottom:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:6px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="font-weight:600; font-size:0.9rem;">Header</span>
                        <label class="switch" style="transform:scale(0.8)"><input type="checkbox" id="exHeaderOn"><span class="slider-switch"></span></label>
                    </div>
                    <input type="text" id="exHeaderTxt" placeholder="Header Text" class="opt-input" style="width:100%;">
                    <div class="opt-row">
                        <select id="exHeaderAlign" class="opt-input"><option value="left">Left</option><option value="center" selected>Center</option><option value="right">Right</option></select>
                        <input type="number" id="exHeaderSize" value="10" class="opt-input" style="width:60px" placeholder="Size">
                        <input type="color" id="exHeaderColor" value="#333333" class="opt-input" style="padding:0; width:40px; height:26px;">
                    </div>
                </div>

                <div style="margin-bottom:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:6px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="font-weight:600; font-size:0.9rem;">Footer</span>
                        <label class="switch" style="transform:scale(0.8)"><input type="checkbox" id="exFooterOn"><span class="slider-switch"></span></label>
                    </div>
                    <input type="text" id="exFooterTxt" placeholder="Footer Text" class="opt-input" style="width:100%;">
                    <div class="opt-row">
                        <select id="exFooterAlign" class="opt-input"><option value="left">Left</option><option value="center" selected>Center</option><option value="right">Right</option></select>
                        <input type="number" id="exFooterSize" value="10" class="opt-input" style="width:60px" placeholder="Size">
                        <input type="color" id="exFooterColor" value="#333333" class="opt-input" style="padding:0; width:40px; height:26px;">
                    </div>
                </div>
                <div style="margin-top:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:6px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span style="font-weight:600; font-size:0.9rem;">Highest Quality Export</span>
                            <span style="font-size:0.7rem; color:#888; display:block;">Full resolution, uncompressed (larger files)</span>
                        </div>
                        <label class="switch" style="transform:scale(0.8)"><input type="checkbox" id="exHiQuality"><span class="slider-switch"></span></label>
                    </div>
                </div>

                <div style="margin-top:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:6px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span style="font-weight:600; font-size:0.9rem;">Include Background</span>
                            <span style="font-size:0.7rem; color:#888; display:block;">Export with page background (infinite/custom pages)</span>
                        </div>
                        <label class="switch" style="transform:scale(0.8)"><input type="checkbox" id="exIncludeBackground" checked><span class="slider-switch"></span></label>
                    </div>
                </div>

                <div style="margin-top:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:6px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span style="font-weight:600; font-size:0.9rem;">Export as Vector (SVG)</span>
                            <span style="font-size:0.7rem; color:#888; display:block;">Strokes remain editable, crisp at any size</span>
                        </div>
                        <label class="switch" style="transform:scale(0.8)"><input type="checkbox" id="exVectorExport"><span class="slider-switch"></span></label>
                    </div>
                </div>
                <p style="font-size:0.8rem; color:#888; text-align:center; margin-top: 15px;">Content will be scaled to fit a standard A4 page with headers/footers.</p>
            </div>

            <div style="display:flex; gap:8px; margin-top:auto;">
                <button class="btn btn-primary" style="flex:1; justify-content:center;" onclick="App.processExport()">Download PDF</button>
                <button class="btn" style="justify-content:center; background:var(--bg-tertiary); border:1px solid var(--border);" onclick="App.exportAsSVG()" title="Export current page as SVG (vector)">
                    <i class="bi bi-filetype-svg"></i> SVG
                </button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextToolbar" class="context-toolbar">
        <button class="ctx-btn" id="ctxEditText" title="Edit Text" onclick="App.editSelectedText()" style="display:none;"><i class="bi bi-pencil"></i></button>
        <button class="ctx-btn" id="ctxGroup" title="Group (Ctrl+G)" onclick="App.groupSelected()" style="display:none;"><i class="bi bi-collection"></i></button>
        <button class="ctx-btn" id="ctxUngroup" title="Ungroup (Ctrl+Shift+G)" onclick="App.ungroupSelected()" style="display:none;"><i class="bi bi-collection-fill"></i></button>
        <button class="ctx-btn" id="ctxStrokeBtn" title="Stroke Color" onclick="App.openPicker('selectionStroke')"><i class="bi bi-circle"></i><span id="ctxStrokeIndicator" class="color-indicator" style="background:#fff;"></span></button>
        <button class="ctx-btn" id="ctxFillBtn" title="Fill Color" onclick="App.openPicker('selectionFill')"><i class="bi bi-circle-fill"></i><span id="ctxFillIndicator" class="color-indicator" style="background:transparent; border-style:dashed;"></span></button>
        <div class="ctx-divider" id="ctxColorDivider"></div>
        <button class="ctx-btn" title="Flip H" onclick="App.flipSelection('horizontal')"><i class="bi bi-symmetry-vertical"></i></button>
        <button class="ctx-btn" title="Flip V" onclick="App.flipSelection('vertical')"><i class="bi bi-symmetry-horizontal"></i></button>
        <div class="ctx-divider"></div>
        <button class="ctx-btn" title="Duplicate" onclick="App.copySelected()"><i class="bi bi-copy"></i></button>
        <button class="ctx-btn delete" title="Delete" onclick="App.deleteSelected()"><i class="bi bi-trash3"></i></button>
        <div class="ctx-divider"></div>
        <div style="position:relative;">
            <button class="ctx-btn" onclick="document.getElementById('ctxDrop').classList.toggle('show')"><i class="bi bi-three-dots"></i></button>
            <div id="ctxDrop" class="ctx-dropdown">
                <div class="ctx-row" onclick="App.copySelected()"><i class="bi bi-clipboard"></i> Copy</div>
                <div class="ctx-row" onclick="App.copySelected(true)"><i class="bi bi-scissors"></i> Cut</div>
                <div class="ctx-row" id="ctxLockRow" onclick="App.lockSelected(); document.getElementById('ctxDrop').classList.remove('show');" style="display:none;"><i class="bi bi-lock"></i> Lock</div>
                <div class="ctx-row" id="ctxUnlockRow" onclick="App.unlockSelected(); document.getElementById('ctxDrop').classList.remove('show');" style="display:none;"><i class="bi bi-unlock"></i> Unlock</div>
                <div class="ctx-row" id="ctxGroupMenu" onclick="App.groupSelected()" style="display:none;"><i class="bi bi-collection"></i> Group</div>
                <div class="ctx-row" id="ctxUngroupMenu" onclick="App.ungroupSelected()" style="display:none;"><i class="bi bi-collection-fill"></i> Ungroup</div>
                <div style="height:1px; background:#333; margin:4px 0;"></div>
                <div style="padding:6px 14px; font-size:0.7rem; color:#666; text-transform:uppercase;">Settings</div>
                <label class="ctx-row" style="cursor:pointer;"><input type="checkbox" id="ctxAspectRatio" onchange="App.setKeepAspectRatio(this.checked)" style="margin-right:8px;"> Keep Aspect Ratio</label>
                <label class="ctx-row" style="cursor:pointer;"><input type="checkbox" id="ctxSnapToGrid" onchange="App.setSnapToGrid(this.checked)" style="margin-right:8px;"> Snap to Grid</label>
                <label class="ctx-row" style="cursor:pointer;"><input type="checkbox" id="ctxHoldToShape" onchange="App.setHoldToShape(this.checked)" style="margin-right:8px;"> Hold to Shape</label>
            </div>
        </div>
    </div>

    <!-- Picker -->
    <div id="floatingPicker">
        <div class="picker-header" id="pickerDragHandle">
            <span id="pickerTitle">Pick Color</span>
            <button id="closePicker" style="background:none; border:none; color:#aaa;"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="picker-body">
            <div id="iroWheel"></div>
            <button id="pickerActionBtn" class="btn btn-primary" style="width:100%; margin-top:10px;">Set</button>
            <button id="pickerNoneBtn" class="btn" style="width:100%; margin-top:5px; display:none">Transparent</button>
        </div>
    </div>

    <input type="file" id="fileIn" accept="image/*,.pdf,.svg" style="display:none" multiple>
    <input type="file" id="splitViewFileIn" accept=".pdf" style="display:none">

    <!-- PDF Library Target Selection Modal -->
    <div id="sharedPdfImportModal" class="overlay" style="z-index:350; display:none;">
        <div class="card" style="max-width:420px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 style="margin:0">Open PDF Library</h3>
                <button onclick="document.getElementById('sharedPdfImportModal').style.display='none'" style="background:none; border:none; color:#aaa; cursor:pointer;"><i class="bi bi-x-lg"></i></button>
            </div>
            <p style="margin:0 0 14px 0; font-size:0.85rem; color:#888; line-height:1.4;">
                Choose where to import the PDF.
            </p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-primary" onclick="document.getElementById('sharedPdfImportModal').style.display='none'; window.CommonPdfImport?.showLibrary('main')" style="justify-content:center;">
                    <i class="bi bi-brush"></i> Main
                </button>
                <button class="btn" onclick="document.getElementById('sharedPdfImportModal').style.display='none'; window.CommonPdfImport?.showLibrary('split')" style="justify-content:center; border-color:#444;">
                    <i class="bi bi-diagram-2"></i> Split
                </button>
            </div>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center; gap:12px;">
            <a href="/" class="btn btn-icon" title="Home" style="text-decoration:none; color:white; background:transparent; border:none; padding:0;">
                <svg width="20" height="20" viewBox="0 0 76 65" fill="#fff"><path d="M37.5274 0L75.0548 65H0L37.5274 0Z"></path></svg>
            </a>
            <div style="width:1px; height:20px; background:#262626;"></div>
            <span style="font-weight:600; font-size:0.9rem; letter-spacing:-0.02em; color:#fafafa;" id="headerTitle">Untitled</span>
            <div id="syncStatus" style="display:flex; align-items:center; gap:6px;">
                <button id="syncToggle" title="Sync status" onclick="window.App?.toggleSync()" style="background:transparent; border:none; color:#4ade80; cursor:pointer; padding:4px; display:flex; align-items:center;">
                    <i class="bi bi-cloud-check"></i>
                </button>
            </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn btn-icon" title="Undo" onclick="window.App?.undo()" style="background:transparent; border:none; color:#888;"><i class="bi bi-arrow-counterclockwise"></i></button>
            <button class="btn btn-icon" title="Redo" onclick="window.App?.redo()" style="background:transparent; border:none; color:#888;"><i class="bi bi-arrow-clockwise"></i></button>
            <div style="width:1px; height:20px; background:#262626;"></div>
            <button class="btn btn-icon" title="Share" onclick="window.App?.shareSession()" style="background:transparent; border:none; color:#888;"><i class="bi bi-share"></i></button>
            <button class="btn" onclick="window.UI?.showDashboard()" style="background:transparent; border:1px solid #262626; color:#fafafa; font-weight:500; padding:8px 14px;">Projects</button>
            <button class="btn btn-primary" onclick="window.UI?.showExportModal()" style="font-weight:600; padding:8px 16px;">Export</button>
        </div>
    </header>

    <div class="workspace">
        <aside class="sidebar" id="sidebar">
            <!-- Desktop: Right Edge Handle -->
            <div class="resize-handle-side" id="resizerSide"></div>
            
            <!-- Mobile: Top Edge Handle -->
            <div class="resize-handle-top" id="resizerTop"></div>

            <!-- Sidebar Tabs -->
            <div class="sb-tabs">
                <div class="sb-tab active" id="tabTools" onclick="window.App.switchSideTab('tools')">Tools</div>
                <div class="sb-tab" id="tabPages" onclick="window.App.switchSideTab('pages')">Pages</div>
                <div class="sb-tab" id="tabBox" onclick="window.App.switchSideTab('box')">Box</div>
                <div class="sb-tab" id="tabDebug" onclick="window.App.switchSideTab('debug')">Trace</div>
            </div>

            <div class="sidebar-content" id="panelTools">
                <div class="control-section">
                    <h4>Instruments</h4>
                    <div class="tool-row">
                        <button class="btn tool-btn" id="toolNone" onclick="App.setTool('none')"><i class="bi bi-cursor"></i> Move (V)</button>
                        <button class="btn tool-btn" id="toolHand" onclick="App.setTool('hand')"><i class="bi bi-hand-index-thumb"></i> Hand (H)</button>
                        <button class="btn tool-btn" id="toolLasso" onclick="App.setTool('lasso')"><i class="bi bi-bounding-box-circles"></i> Lasso (L)</button>
                    </div>
                    <div class="tool-row">
                        <button class="btn tool-btn" id="toolPen" onclick="App.setTool('pen')"><i class="bi bi-pen"></i> Pen (P)</button>
                        <button class="btn tool-btn" id="toolShape" onclick="App.setTool('shape')"><i class="bi bi-square"></i> Shape (S)</button>
                        <button class="btn tool-btn" id="toolText" onclick="App.setTool('text')"><i class="bi bi-fonts"></i> Text (T)</button>
                    </div>
                    <div class="tool-row">
                        <button class="btn tool-btn" id="toolEraser" onclick="App.setTool('eraser')"><i class="bi bi-eraser"></i> Erase (E)</button>
                        <button class="btn tool-btn" id="toolCapture" onclick="App.setTool('capture')" style="border-color:#444;"><i class="bi bi-plus-square-dotted"></i> Box (B)</button>
                    </div>

                    <!-- Eraser Options Panel -->
                    <div id="eraserOptions" style="display:none; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px; margin-top:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <span style="font-size:0.8rem; color:#aaa">Erase Specific Types</span>
                            <label class="switch" style="transform:scale(0.8)">
                                <input type="checkbox" id="strokeEraserToggle" onchange="App.setEraserMode(this.checked)">
                                <span class="slider-switch"></span>
                            </label>
                        </div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <label style="display:flex; align-items:center; gap:4px; font-size:0.75rem; color:#888;">
                                <input type="checkbox" id="eraseScribble" checked onchange="App.setEraseOption('scribble', this.checked)"> Scribble
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:0.75rem; color:#888;">
                                <input type="checkbox" id="eraseText" checked onchange="App.setEraseOption('text', this.checked)"> Text
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:0.75rem; color:#888;">
                                <input type="checkbox" id="eraseShapes" checked onchange="App.setEraseOption('shapes', this.checked)"> Shapes
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:0.75rem; color:#888;">
                                <input type="checkbox" id="eraseImages" onchange="App.setEraseOption('images', this.checked)"> Images
                            </label>
                        </div>
                    </div>

                    <!-- Lasso Options Panel -->
                    <div id="lassoOptions" style="display:none; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px; margin-top:8px;">
                        <div style="margin-bottom:8px;">
                            <span style="font-size:0.75rem; color:#888; font-weight:600; text-transform:uppercase;">Select Types</span>
                        </div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                            <label style="display:flex; align-items:center; gap:4px; font-size:0.75rem; color:#888;">
                                <input type="checkbox" id="lassoScribble" checked onchange="App.setLassoOption('scribble', this.checked)"> Scribble
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:0.75rem; color:#888;">
                                <input type="checkbox" id="lassoText" checked onchange="App.setLassoOption('text', this.checked)"> Text
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:0.75rem; color:#888;">
                                <input type="checkbox" id="lassoShapes" checked onchange="App.setLassoOption('shapes', this.checked)"> Shapes
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:0.75rem; color:#888;">
                                <input type="checkbox" id="lassoImages" checked onchange="App.setLassoOption('images', this.checked)"> Images
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:0.75rem; color:#888;">
                                <input type="checkbox" id="lassoLocked" onchange="App.setLassoOption('locked', this.checked)"> Locked
                            </label>
                        </div>
                        <!-- SOTA Alignment Tools -->
                        <div style="border-top:1px solid #333; padding-top:10px; margin-top:5px;">
                            <span style="font-size:0.75rem; color:#888; font-weight:600; text-transform:uppercase; display:block; margin-bottom:8px;">Align Selected</span>
                            <div style="display:flex; gap:4px; flex-wrap:wrap;">
                                <button class="btn btn-sm" onclick="App.alignSelection('left')" title="Align Left" style="padding:6px 8px;"><i class="bi bi-align-start"></i></button>
                                <button class="btn btn-sm" onclick="App.alignSelection('center')" title="Align Center" style="padding:6px 8px;"><i class="bi bi-align-center"></i></button>
                                <button class="btn btn-sm" onclick="App.alignSelection('right')" title="Align Right" style="padding:6px 8px;"><i class="bi bi-align-end"></i></button>
                                <div style="width:1px; height:24px; background:#333;"></div>
                                <button class="btn btn-sm" onclick="App.alignSelection('top')" title="Align Top" style="padding:6px 8px;"><i class="bi bi-align-top"></i></button>
                                <button class="btn btn-sm" onclick="App.alignSelection('middle')" title="Align Middle" style="padding:6px 8px;"><i class="bi bi-align-middle"></i></button>
                                <button class="btn btn-sm" onclick="App.alignSelection('bottom')" title="Align Bottom" style="padding:6px 8px;"><i class="bi bi-align-bottom"></i></button>
                            </div>
                            <span style="font-size:0.75rem; color:#888; font-weight:600; text-transform:uppercase; display:block; margin:10px 0 8px 0;">Distribute</span>
                            <div style="display:flex; gap:4px; flex-wrap:wrap;">
                                <button class="btn btn-sm" onclick="App.distributeSelection('horizontal')" title="Distribute Horizontally" style="padding:6px 8px;"><i class="bi bi-distribute-horizontal"></i></button>
                                <button class="btn btn-sm" onclick="App.distributeSelection('vertical')" title="Distribute Vertically" style="padding:6px 8px;"><i class="bi bi-distribute-vertical"></i></button>
                            </div>
                            <span style="font-size:0.75rem; color:#888; font-weight:600; text-transform:uppercase; display:block; margin:10px 0 8px 0;">Transform</span>
                            <div style="display:flex; gap:4px; flex-wrap:wrap; align-items:center;">
                                <button class="btn btn-sm" onclick="App.flipSelection('horizontal')" title="Flip Horizontal" style="padding:6px 8px;"><i class="bi bi-symmetry-vertical"></i></button>
                                <button class="btn btn-sm" onclick="App.flipSelection('vertical')" title="Flip Vertical" style="padding:6px 8px;"><i class="bi bi-symmetry-horizontal"></i></button>
                                <span id="sidebarRotationAngle" style="font-size:0.7rem; color:#888; padding:4px 8px; background:#111; border-radius:4px;">0°</span>
                            </div>
                            <label style="display:flex; align-items:center; gap:6px; font-size:0.75rem; color:#888; margin-top:8px; cursor:pointer;">
                                <input type="checkbox" id="sidebarAspectRatio" onchange="App.setKeepAspectRatio(this.checked)"> Keep Aspect Ratio
                            </label>
                            <span style="font-size:0.75rem; color:#888; font-weight:600; text-transform:uppercase; display:block; margin:10px 0 8px 0;">Layer Order</span>
                            <div style="display:flex; gap:4px; flex-wrap:wrap;">
                                <button class="btn btn-sm" onclick="App.changeLayerOrder('front')" title="Bring to Front" style="padding:6px 8px;"><i class="bi bi-front"></i></button>
                                <button class="btn btn-sm" onclick="App.changeLayerOrder('forward')" title="Bring Forward" style="padding:6px 8px;"><i class="bi bi-chevron-up"></i></button>
                                <button class="btn btn-sm" onclick="App.changeLayerOrder('backward')" title="Send Backward" style="padding:6px 8px;"><i class="bi bi-chevron-down"></i></button>
                                <button class="btn btn-sm" onclick="App.changeLayerOrder('back')" title="Send to Back" style="padding:6px 8px;"><i class="bi bi-back"></i></button>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px; padding:12px; border:1px solid #222; border-radius:6px; background:#0a0a0a;">
                        <span style="font-size:0.75rem; color:#888; font-weight:600; text-transform:uppercase;">Preview</span>
                        <label class="switch">
                            <input type="checkbox" id="previewToggle">
                            <span class="slider-switch"></span>
                        </label>
                    </div>

                    <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; border:1px solid #222; border-radius:6px; background:#0a0a0a;">
                        <span style="font-size:0.75rem; color:#888; font-weight:600; text-transform:uppercase;">Cursors</span>
                        <label class="switch">
                            <input type="checkbox" id="cursorToggle" checked>
                            <span class="slider-switch"></span>
                        </label>
                    </div>


                    <!-- Settings Panel -->
                    <div id="toolSettingsPanel" style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-bottom:10px; display:none;">

                        <div id="penOptions" style="display:none;">
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                                <div class="color-dot" style="background:#ef4444" onclick="App.setPenColor('#ef4444')"></div>
                                <div class="color-dot" style="background:#3b82f6" onclick="App.setPenColor('#3b82f6')"></div>
                                <div class="color-dot" style="background:#000" onclick="App.setPenColor('#000000')"></div>
                                <div id="customSwatches" style="display:flex; gap:4px; align-items:center; flex-wrap:wrap;"></div>
                                <button class="btn btn-sm" onclick="App.openPicker('pen')" title="Custom Color" style="width:22px; height:22px; padding:0; justify-content:center; border-radius:4px;"><i class="bi bi-plus"></i></button>
                            </div>

                            <!-- Stabilization Slider -->
                            <div style="margin-top:12px; padding:10px; background:rgba(0,0,0,0.3); border-radius:6px;">
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                                    <span style="font-size:0.75rem; color:#888; font-weight:600;">STABILIZATION</span>
                                    <span id="stabilizationValue" style="font-size:0.7rem; color:#fff; font-family:monospace;">0%</span>
                                </div>
                                <input type="range" id="stabilizationSlider" min="0" max="100" value="0" class="slider" style="width:100%;" oninput="App.setStabilization(this.value)">
                                <div style="display:flex; justify-content:space-between; font-size:0.6rem; color:#555; margin-top:2px;">
                                    <span>Raw</span>
                                    <span>Smooth</span>
                                </div>
                            </div>

                            <!-- Hold to Shape Toggle -->
                            <div style="margin-top:10px; display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:rgba(0,0,0,0.3); border-radius:6px;">
                                <div>
                                    <span style="font-size:0.75rem; color:#888; font-weight:600;">HOLD TO SHAPE</span>
                                    <div style="font-size:0.6rem; color:#555;">Hold still to snap to shape</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="holdToShapeToggle" onchange="App.setHoldToShape(this.checked)">
                                    <span class="slider-switch"></span>
                                </label>
                            </div>

                            <!-- Stylus Engine Toggle -->
                            <div style="margin-top:10px; display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:rgba(0,0,0,0.3); border-radius:6px;">
                                <div>
                                    <span style="font-size:0.75rem; color:#888; font-weight:600;">S-PEN ENGINE</span>
                                    <div style="font-size:0.6rem; color:#555;">Samsung S-Pen button support</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="spenEngineToggle" checked onchange="App.setSpenEngine(this.checked)">
                                    <span class="slider-switch"></span>
                                </label>
                            </div>
                        </div>

                        <div id="shapeOptions" style="display:none;">
                            <div class="shape-grid">
                                <div class="shape-btn" id="sh_rectangle" onclick="App.setShapeType('rectangle')" title="Rectangle"><i class="bi bi-square"></i></div>
                                <div class="shape-btn" id="sh_circle" onclick="App.setShapeType('circle')" title="Circle/Ellipse"><i class="bi bi-circle"></i></div>
                                <div class="shape-btn" id="sh_line" onclick="App.setShapeType('line')" title="Line"><i class="bi bi-dash-lg"></i></div>
                                <div class="shape-btn" id="sh_arrow" onclick="App.setShapeType('arrow')" title="Arrow"><i class="bi bi-arrow-right"></i></div>
                                <div class="shape-btn" id="sh_triangle" onclick="App.setShapeType('triangle')" title="Triangle"><i class="bi bi-triangle"></i></div>
                                <div class="shape-btn" id="sh_diamond" onclick="App.setShapeType('diamond')" title="Diamond"><i class="bi bi-diamond"></i></div>
                                <div class="shape-btn" id="sh_star" onclick="App.setShapeType('star')" title="Star"><i class="bi bi-star"></i></div>
                                <div class="shape-btn" id="sh_hexagon" onclick="App.setShapeType('hexagon')" title="Hexagon"><i class="bi bi-hexagon"></i></div>
                                <div class="shape-btn" id="sh_pentagon" onclick="App.setShapeType('pentagon')" title="Pentagon"><i class="bi bi-pentagon"></i></div>
                                <div class="shape-btn" id="sh_octagon" onclick="App.setShapeType('octagon')" title="Octagon"><i class="bi bi-octagon"></i></div>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                                <button class="btn btn-sm" onclick="App.openPicker('shapeBorder')">Border</button>
                                <button class="btn btn-sm" onclick="App.openPicker('shapeFill')">Fill</button>
                            </div>
                        </div>

                        <!-- Text Options -->
                        <div id="textOptions" style="display:none;">
                            <div style="margin-bottom:10px;">
                                <span style="font-size:0.75rem; color:#888; font-weight:600; display:block; margin-bottom:6px;">QUICK SIZES</span>
                                <div style="display:flex; gap:4px; flex-wrap:wrap;">
                                    <button class="btn btn-sm" onclick="App.setTextSize(12)" style="min-width:36px;">12</button>
                                    <button class="btn btn-sm" onclick="App.setTextSize(16)" style="min-width:36px;">16</button>
                                    <button class="btn btn-sm" onclick="App.setTextSize(24)" style="min-width:36px;">24</button>
                                    <button class="btn btn-sm" onclick="App.setTextSize(32)" style="min-width:36px;">32</button>
                                    <button class="btn btn-sm" onclick="App.setTextSize(48)" style="min-width:36px;">48</button>
                                    <button class="btn btn-sm" onclick="App.setTextSize(72)" style="min-width:36px;">72</button>
                                </div>
                            </div>
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                                <span style="font-size:0.75rem; color:#888; font-weight:600;">COLOR</span>
                                <div class="color-dot" style="background:#000" onclick="App.setPenColor('#000000')"></div>
                                <div class="color-dot" style="background:#ef4444" onclick="App.setPenColor('#ef4444')"></div>
                                <div class="color-dot" style="background:#3b82f6" onclick="App.setPenColor('#3b82f6')"></div>
                                <div class="color-dot" style="background:#22c55e" onclick="App.setPenColor('#22c55e')"></div>
                                <button class="btn btn-sm" onclick="App.openPicker('pen')" title="Custom Color" style="width:22px; height:22px; padding:0; justify-content:center; border-radius:4px;"><i class="bi bi-plus"></i></button>
                            </div>
                            <div style="margin-top:10px; padding:8px; background:rgba(0,0,0,0.3); border-radius:6px; font-size:0.7rem; color:#666;">
                                <i class="bi bi-info-circle"></i> Click on canvas to add text. Double-click existing text to edit.
                            </div>
                        </div>

                         <div style="margin-top:10px; display:flex; align-items:center; gap:8px;">
                            <span style="font-size:0.7rem; color:#aaa;" id="sizeLabel">Size</span>
                            <input type="range" id="brushSize" min="1" max="100" value="3" class="slider" style="flex:1">
                        </div>
                    </div>
                </div>

                <!-- Bookmarks Section -->
                <div class="control-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <h4><i class="bi bi-bookmark-fill"></i> Bookmarks</h4>
                        <button class="btn btn-sm" onclick="App.initBookmark()"><i class="bi bi-plus"></i></button>
                    </div>
                    <div id="bookmarkList" class="bm-list">
                        <div style="color:#666; font-size:0.8rem; text-align:center; padding:10px;">No bookmarks yet.</div>
                    </div>
                </div>

                <div class="control-section">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4>Colors to Keep</h4>
                        <div style="display:flex; gap:4px;">
                            <button class="btn btn-sm" id="eyedropperBtn" title="Pick color from image"><i class="bi bi-eyedropper"></i></button>
                            <button class="btn btn-sm" id="openColorPicker"><i class="bi bi-plus-lg"></i> Add</button>
                        </div>
                    </div>
                    <div id="swatches" class="swatch-grid"></div>
                    <div style="margin-top:10px;">
                        <span style="font-size:0.8rem; color:#aaa">Tolerance</span>
                        <input type="range" id="strictRange" min="1" max="100" value="15" class="slider">
                    </div>
                </div>

                <!-- Users Section -->
                <div class="control-section">
                    <h4><i class="bi bi-people-fill"></i> Active Users</h4>
                    <div id="userList" class="user-list">
                        <div style="color:#666; font-size:0.8rem; text-align:center; padding:10px;">Connecting presence...</div>
                    </div>
                </div>
            </div>

            <!-- Pages Panel -->
            <div class="sidebar-content" id="panelPages" style="display:none">
                <div class="control-section">
                    <h4><i class="bi bi-files"></i> Page Management</h4>

                    <!-- Simplified Page Controls -->
                    <div class="page-controls" style="display:flex; flex-direction:column; gap:10px;">
                        <button class="btn" style="width:100%; justify-content:center; background:linear-gradient(135deg, #6366f1, #8b5cf6); color:white; padding:12px; font-weight:600;" onclick="window.App.showAddPageModal()">
                            <i class="bi bi-plus-lg"></i> Add New Page
                        </button>

                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-sm" style="flex:1; justify-content:center;" onclick="window.App.reorderPages()">
                                <i class="bi bi-arrow-down-up"></i> Reorder
                            </button>
                            <button class="btn btn-sm" style="flex:1; justify-content:center; background:#dc2626; color:white;" onclick="window.App.deleteCurrentPage()">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>

                    <input type="file" id="addImagePageInput" accept="image/*" style="display:none" onchange="window.App.handleImagePageUpload(event, false)">
                    <input type="file" id="addImagePageInputCurrent" accept="image/*" style="display:none" onchange="window.App.handleImagePageUpload(event, true)">
                </div>

                <div id="sbPageList" class="sb-page-grid"></div>

                <!-- Add Page Modal -->
                <div id="addPageModal" class="overlay" style="display:none; z-index:300;">
                    <div class="card" style="max-width:480px; width:95%; background:var(--bg-panel); border:1px solid var(--border); max-height:90vh; overflow-y:auto;">
                        <!-- Header -->
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid var(--border);">
                            <h3 style="margin:0; color:white; font-size:1.2rem; display:flex; align-items:center; gap:8px;">
                                <i class="bi bi-file-earmark-plus" style="color:#8b5cf6;"></i> Add New Page
                            </h3>
                            <button onclick="document.getElementById('addPageModal').style.display='none'" style="background:var(--bg); border:1px solid var(--border); color:#888; cursor:pointer; width:32px; height:32px; border-radius:4px; display:flex; align-items:center; justify-content:center;">×</button>
                        </div>

                        <!-- Tab Navigation -->
                        <div style="display:flex; gap:4px; margin-bottom:20px; background:var(--bg); padding:4px; border-radius:8px;">
                            <button class="page-modal-tab active" data-tab="blank" onclick="window.App.switchPageModalTab('blank')" style="flex:1; padding:10px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.2s;">
                                <i class="bi bi-file-earmark"></i> Blank
                            </button>
                            <button class="page-modal-tab" data-tab="template" onclick="window.App.switchPageModalTab('template')" style="flex:1; padding:10px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.2s;">
                                <i class="bi bi-grid-3x3"></i> Template
                            </button>
                            <button class="page-modal-tab" data-tab="import" onclick="window.App.switchPageModalTab('import')" style="flex:1; padding:10px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.2s;">
                                <i class="bi bi-image"></i> Import
                            </button>
                        </div>

                        <!-- Blank Page Tab -->
                        <div id="pageModalBlank" class="page-modal-content">
                            <!-- Size Selection -->
                            <div style="margin-bottom:20px;">
                                <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:10px; font-weight:600;">PAGE SIZE</label>
                                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">
                                    <button class="size-preset-btn active" data-size="2000x1500" onclick="window.App.selectPageSize(2000, 1500, this)">
                                        <div style="font-weight:600;">Large</div>
                                        <div style="font-size:0.7rem; opacity:0.7;">2000×1500</div>
                                    </button>
                                    <button class="size-preset-btn" data-size="1600x1200" onclick="window.App.selectPageSize(1600, 1200, this)">
                                        <div style="font-weight:600;">Medium</div>
                                        <div style="font-size:0.7rem; opacity:0.7;">1600×1200</div>
                                    </button>
                                    <button class="size-preset-btn" data-size="1024x768" onclick="window.App.selectPageSize(1024, 768, this)">
                                        <div style="font-weight:600;">Small</div>
                                        <div style="font-size:0.7rem; opacity:0.7;">1024×768</div>
                                    </button>
                                    <button class="size-preset-btn" data-size="2480x3508" onclick="window.App.selectPageSize(2480, 3508, this)">
                                        <div style="font-weight:600;">A4</div>
                                        <div style="font-size:0.7rem; opacity:0.7;">Portrait</div>
                                    </button>
                                    <button class="size-preset-btn" data-size="3508x2480" onclick="window.App.selectPageSize(3508, 2480, this)">
                                        <div style="font-weight:600;">A4</div>
                                        <div style="font-size:0.7rem; opacity:0.7;">Landscape</div>
                                    </button>
                                    <button class="size-preset-btn" data-size="custom" onclick="window.App.toggleCustomSize()">
                                        <div style="font-weight:600;">Custom</div>
                                        <div style="font-size:0.7rem; opacity:0.7;">Set size</div>
                                    </button>
                                </div>

                                <!-- Custom Size Inputs (hidden by default) -->
                                <div id="customSizeInputs" style="display:none; margin-top:12px; padding:12px; background:var(--bg); border-radius:8px;">
                                    <div style="display:flex; gap:10px; align-items:center;">
                                        <input type="number" id="newPageWidth" placeholder="Width" value="2000" style="flex:1; padding:10px; background:var(--bg-panel); border:1px solid var(--border); border-radius:6px; color:white;">
                                        <span style="color:#666;">×</span>
                                        <input type="number" id="newPageHeight" placeholder="Height" value="1500" style="flex:1; padding:10px; background:var(--bg-panel); border:1px solid var(--border); border-radius:6px; color:white;">
                                    </div>
                                </div>
                            </div>

                            <!-- Background Color -->
                            <div style="margin-bottom:20px;">
                                <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:10px; font-weight:600;">BACKGROUND COLOR</label>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <input type="color" id="blankPageColor" value="#ffffff" style="width:44px; height:44px; border:2px solid var(--border); border-radius:8px; background:none; cursor:pointer; padding:2px;">
                                    <div style="display:flex; gap:6px; flex-wrap:wrap;">
                                        <div class="color-preset" style="background:#ffffff;" onclick="document.getElementById('blankPageColor').value='#ffffff';"></div>
                                        <div class="color-preset" style="background:#f5f5f5;" onclick="document.getElementById('blankPageColor').value='#f5f5f5';"></div>
                                        <div class="color-preset" style="background:#ffffcc;" onclick="document.getElementById('blankPageColor').value='#ffffcc';"></div>
                                        <div class="color-preset" style="background:#e8f5e9;" onclick="document.getElementById('blankPageColor').value='#e8f5e9';"></div>
                                        <div class="color-preset" style="background:#e3f2fd;" onclick="document.getElementById('blankPageColor').value='#e3f2fd';"></div>
                                        <div class="color-preset" style="background:#1a1a1a;" onclick="document.getElementById('blankPageColor').value='#1a1a1a';"></div>
                                        <div class="color-preset" style="background:#000000;" onclick="document.getElementById('blankPageColor').value='#000000';"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Insert Position -->
                            <div style="margin-bottom:20px;">
                                <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:10px; font-weight:600;">INSERT POSITION</label>
                                <div style="display:flex; gap:8px;">
                                    <button class="insert-pos-btn active" data-pos="end" onclick="window.App.selectInsertPosition('end', this)">
                                        <i class="bi bi-box-arrow-in-down"></i> At End
                                    </button>
                                    <button class="insert-pos-btn" data-pos="after" onclick="window.App.selectInsertPosition('after', this)">
                                        <i class="bi bi-box-arrow-in-right"></i> After Current
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Template Tab -->
                        <div id="pageModalTemplate" class="page-modal-content" style="display:none;">
                            <!-- Insert Position (unified with blank tab) -->
                            <div style="margin-bottom:20px;">
                                <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:10px; font-weight:600;">INSERT POSITION</label>
                                <div style="display:flex; gap:8px;">
                                    <button class="insert-pos-btn-template active" data-pos="end" onclick="window.App.selectInsertPosition('end', this, 'template')">
                                        <i class="bi bi-box-arrow-in-down"></i> At End
                                    </button>
                                    <button class="insert-pos-btn-template" data-pos="after" onclick="window.App.selectInsertPosition('after', this, 'template')">
                                        <i class="bi bi-box-arrow-in-right"></i> After Current
                                    </button>
                                </div>
                            </div>
                            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
                                <button class="template-btn" onclick="window.App.createPageFromModal('white')">
                                    <div class="template-preview" style="background:#ffffff;"></div>
                                    <div class="template-label">Plain White</div>
                                </button>
                                <button class="template-btn" onclick="window.App.createPageFromModal('graph')">
                                    <div class="template-preview" style="background:linear-gradient(90deg, #e0e0e0 1px, transparent 1px), linear-gradient(#e0e0e0 1px, transparent 1px); background-size:10px 10px; background-color:#ffffff;"></div>
                                    <div class="template-label">Graph Paper</div>
                                </button>
                                <button class="template-btn" onclick="window.App.createPageFromModal('lined')">
                                    <div class="template-preview" style="background:repeating-linear-gradient(0deg, transparent, transparent 9px, #e0e0e0 9px, #e0e0e0 10px); background-color:#ffffff;"></div>
                                    <div class="template-label">Lined Paper</div>
                                </button>
                                <button class="template-btn" onclick="window.App.createPageFromModal('dotted')">
                                    <div class="template-preview" style="background:radial-gradient(circle, #ccc 1px, transparent 1px); background-size:12px 12px; background-color:#ffffff;"></div>
                                    <div class="template-label">Dotted Grid</div>
                                </button>
                                <button class="template-btn" onclick="window.App.showInfiniteCanvasOptions()" style="grid-column: span 2;">
                                    <div class="template-preview" style="background:linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); position:relative; overflow:hidden;">
                                        <div style="position:absolute; inset:0; background:radial-gradient(circle at 30% 40%, rgba(99,102,241,0.3) 0%, transparent 40%), radial-gradient(circle at 70% 60%, rgba(139,92,246,0.3) 0%, transparent 40%);"></div>
                                        <i class="bi bi-infinity" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:1.5rem; color:rgba(255,255,255,0.6);"></i>
                                    </div>
                                    <div class="template-label">Infinite Canvas <span style="font-size:0.7rem; color:#8b5cf6; font-weight:normal;">∞ Expand as you draw</span></div>
                                </button>
                            </div>
                        </div>

                        <!-- Infinite Canvas Options Panel (hidden by default) -->
                        <div id="infiniteCanvasOptions" class="page-modal-content" style="display:none;">
                            <div style="margin-bottom:20px;">
                                <button class="btn" onclick="window.App.switchPageModalTab('template')" style="padding:6px 12px; font-size:0.85rem;">
                                    <i class="bi bi-arrow-left"></i> Back to Templates
                                </button>
                            </div>

                            <h4 style="color:white; margin-bottom:15px; font-size:1rem;">
                                <i class="bi bi-infinity" style="color:#8b5cf6;"></i> Infinite Canvas Options
                            </h4>

                            <!-- Insert Position (unified with other tabs) -->
                            <div style="margin-bottom:20px;">
                                <label style="color:#888; font-size:0.85rem; display:block; margin-bottom:8px;">Insert Position</label>
                                <div style="display:flex; gap:8px;">
                                    <button class="insert-pos-btn-infinite active" data-pos="end" onclick="window.App.selectInsertPosition('end', this, 'infinite')" style="flex:1; padding:10px; border:2px solid var(--border); border-radius:8px; background:var(--bg); cursor:pointer; color:white; font-size:0.85rem;">
                                        <i class="bi bi-box-arrow-in-down"></i> At End
                                    </button>
                                    <button class="insert-pos-btn-infinite" data-pos="after" onclick="window.App.selectInsertPosition('after', this, 'infinite')" style="flex:1; padding:10px; border:2px solid var(--border); border-radius:8px; background:var(--bg); cursor:pointer; color:white; font-size:0.85rem;">
                                        <i class="bi bi-box-arrow-in-right"></i> After Current
                                    </button>
                                </div>
                            </div>

                            <!-- Background Style -->
                            <div style="margin-bottom:20px;">
                                <label style="color:#888; font-size:0.85rem; display:block; margin-bottom:8px;">Background Style</label>
                                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">
                                    <button class="infinite-bg-btn active" data-bg="dark" onclick="window.App.selectInfiniteBg('dark', this)" style="padding:12px 8px; border:2px solid var(--border); border-radius:8px; background:linear-gradient(135deg, #1a1a2e, #0f3460); cursor:pointer; transition:all 0.2s;">
                                        <div style="font-size:0.75rem; color:white;">Dark</div>
                                    </button>
                                    <button class="infinite-bg-btn" data-bg="light" onclick="window.App.selectInfiniteBg('light', this)" style="padding:12px 8px; border:2px solid var(--border); border-radius:8px; background:linear-gradient(135deg, #f8fafc, #e2e8f0); cursor:pointer; transition:all 0.2s;">
                                        <div style="font-size:0.75rem; color:#333;">Light</div>
                                    </button>
                                    <button class="infinite-bg-btn" data-bg="custom" onclick="window.App.selectInfiniteBg('custom', this)" style="padding:12px 8px; border:2px solid var(--border); border-radius:8px; background:var(--bg); cursor:pointer; transition:all 0.2s;">
                                        <div style="font-size:0.75rem; color:white;">Custom</div>
                                    </button>
                                </div>
                                <div id="infiniteCustomBgPicker" style="display:none; margin-top:10px;">
                                    <div id="iroBgColorWheel" style="display:flex; justify-content:center;"></div>
                                    <input type="hidden" id="infiniteBgColor" value="#1a1a2e">
                                </div>
                            </div>

                            <!-- Grid Style -->
                            <div style="margin-bottom:20px;">
                                <label style="color:#888; font-size:0.85rem; display:block; margin-bottom:8px;">Grid Pattern</label>
                                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">
                                    <button class="infinite-grid-btn active" data-grid="subtle" onclick="window.App.selectInfiniteGrid('subtle', this)" style="padding:10px 6px; border:2px solid var(--border); border-radius:8px; background:var(--bg); cursor:pointer; transition:all 0.2s;">
                                        <i class="bi bi-grid" style="font-size:1rem; color:#666;"></i>
                                        <div style="font-size:0.65rem; color:#888; margin-top:4px;">Subtle</div>
                                    </button>
                                    <button class="infinite-grid-btn" data-grid="dots" onclick="window.App.selectInfiniteGrid('dots', this)" style="padding:10px 6px; border:2px solid var(--border); border-radius:8px; background:var(--bg); cursor:pointer; transition:all 0.2s;">
                                        <i class="bi bi-grid-3x3-gap" style="font-size:1rem; color:#666;"></i>
                                        <div style="font-size:0.65rem; color:#888; margin-top:4px;">Dots</div>
                                    </button>
                                    <button class="infinite-grid-btn" data-grid="lines" onclick="window.App.selectInfiniteGrid('lines', this)" style="padding:10px 6px; border:2px solid var(--border); border-radius:8px; background:var(--bg); cursor:pointer; transition:all 0.2s;">
                                        <i class="bi bi-border-all" style="font-size:1rem; color:#666;"></i>
                                        <div style="font-size:0.65rem; color:#888; margin-top:4px;">Lines</div>
                                    </button>
                                    <button class="infinite-grid-btn" data-grid="none" onclick="window.App.selectInfiniteGrid('none', this)" style="padding:10px 6px; border:2px solid var(--border); border-radius:8px; background:var(--bg); cursor:pointer; transition:all 0.2s;">
                                        <i class="bi bi-x-lg" style="font-size:1rem; color:#666;"></i>
                                        <div style="font-size:0.65rem; color:#888; margin-top:4px;">None</div>
                                    </button>
                                </div>
                            </div>

                            <!-- Grid Color -->
                            <div style="margin-bottom:20px;">
                                <label style="color:#888; font-size:0.85rem; display:block; margin-bottom:8px;">Grid Color & Opacity</label>
                                <div style="display:flex; align-items:flex-start; gap:15px;">
                                    <div id="iroGridColorWheel"></div>
                                    <div style="flex:1; padding-top:10px;">
                                        <input type="hidden" id="infiniteGridColor" value="#ffffff">
                                        <div id="gridColorPreview" style="width:40px; height:40px; border-radius:8px; border:2px solid var(--border); background:#ffffff; margin-bottom:10px;"></div>
                                        <label style="font-size:0.75rem; color:#666; display:block; margin-bottom:4px;">Opacity</label>
                                        <input type="range" id="infiniteGridOpacity" min="1" max="30" value="5" style="width:100%;">
                                        <span id="infiniteGridOpacityLabel" style="color:#666; font-size:0.75rem;">5%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Create Button -->
                            <button class="btn" onclick="window.App.createInfiniteCanvasWithOptions()" style="width:100%; justify-content:center; background:linear-gradient(135deg, #6366f1, #8b5cf6); color:white; font-weight:600; padding:14px;">
                                <i class="bi bi-plus-lg"></i> Create Infinite Canvas
                            </button>
                        </div>

                        <!-- Import Tab -->
                        <div id="pageModalImport" class="page-modal-content" style="display:none;">
                            <!-- Image Import -->
                            <div style="border:2px dashed var(--border); border-radius:12px; padding:30px 20px; text-align:center; cursor:pointer; transition:all 0.2s; margin-bottom:15px;" onclick="document.getElementById('addImagePageInput').click();" onmouseover="this.style.borderColor='#8b5cf6'; this.style.background='rgba(139,92,246,0.05)';" onmouseout="this.style.borderColor='var(--border)'; this.style.background='transparent';">
                                <i class="bi bi-image" style="font-size:2rem; color:#8b5cf6; display:block; margin-bottom:10px;"></i>
                                <div style="font-weight:600; color:white; margin-bottom:5px;">Import Image</div>
                                <div style="font-size:0.8rem; color:#888;">PNG, JPG, WebP supported</div>
                            </div>

                            <!-- SVG Import -->
                            <div style="border:2px dashed var(--border); border-radius:12px; padding:30px 20px; text-align:center; cursor:pointer; transition:all 0.2s; margin-bottom:15px;" onclick="window.App.importSvgAsInfiniteCanvas();" onmouseover="this.style.borderColor='#10b981'; this.style.background='rgba(16,185,129,0.05)';" onmouseout="this.style.borderColor='var(--border)'; this.style.background='transparent';">
                                <i class="bi bi-filetype-svg" style="font-size:2rem; color:#10b981; display:block; margin-bottom:10px;"></i>
                                <div style="font-weight:600; color:white; margin-bottom:5px;">Import SVG</div>
                                <div style="font-size:0.8rem; color:#888;">Vector graphics as editable elements</div>
                            </div>

                            <!-- PDF Import (Experimental) -->
                            <div style="border:2px dashed var(--border); border-radius:12px; padding:30px 20px; text-align:center; cursor:pointer; transition:all 0.2s; position:relative;" onclick="window.App.importPdf();" onmouseover="this.style.borderColor='#ff6b6b'; this.style.background='rgba(255,107,107,0.05)';" onmouseout="this.style.borderColor='var(--border)'; this.style.background='transparent';">
                                <span style="position:absolute; top:8px; right:8px; background:#ff6b6b; color:white; font-size:0.6rem; padding:2px 6px; border-radius:4px; font-weight:600;">EXPERIMENTAL</span>
                                <i class="bi bi-file-pdf" style="font-size:2rem; color:#ff6b6b; display:block; margin-bottom:10px;"></i>
                                <div style="font-weight:600; color:white; margin-bottom:5px;">Import PDF</div>
                                <div style="font-size:0.8rem; color:#888;">Convert PDF pages to SVG (server-side)</div>
                            </div>

                            <p style="text-align:center; font-size:0.75rem; color:#666; margin-top:15px;">
                                <i class="bi bi-info-circle"></i> Files will be added as new pages
                            </p>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display:flex; gap:10px; margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
                            <button class="btn" style="flex:1; justify-content:center;" onclick="document.getElementById('addPageModal').style.display='none'">
                                Cancel
                            </button>
                            <button id="createPageBtn" class="btn" style="flex:2; justify-content:center; background:linear-gradient(135deg, #6366f1, #8b5cf6); color:white; font-weight:600;" onclick="window.App.createPageFromModal()">
                                <i class="bi bi-plus-lg"></i> Create Page
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Page Size Modal (kept for resize functionality) -->
                <div id="pageSizeModal" class="overlay" style="display:none; z-index:300;">
                    <div class="card" style="max-width:450px; width:90%; background:var(--bg-panel); border:1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid var(--border);">
                            <h3 style="margin:0; color:white; font-size:1.1rem;">Page Size</h3>
                            <button onclick="document.getElementById('pageSizeModal').style.display='none'" style="background:var(--bg); border:1px solid var(--border); color:#888; cursor:pointer; width:32px; height:32px; border-radius:4px; display:flex; align-items:center; justify-content:center;">×</button>
                        </div>

                        <div style="margin-bottom:15px;">
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Standard Sizes</label>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn btn-sm" style="padding:6px 10px; font-size:0.75rem;" onclick="window.App.setPageSize(800, 600)">800×600</button>
                                <button class="btn btn-sm" style="padding:6px 10px; font-size:0.75rem;" onclick="window.App.setPageSize(1024, 768)">1024×768</button>
                                <button class="btn btn-sm" style="padding:6px 10px; font-size:0.75rem;" onclick="window.App.setPageSize(1200, 900)">1200×900</button>
                                <button class="btn btn-sm" style="padding:6px 10px; font-size:0.75rem;" onclick="window.App.setPageSize(1600, 1200)">1600×1200</button>
                                <button class="btn btn-sm" style="padding:6px 10px; font-size:0.75rem;" onclick="window.App.setPageSize(2000, 1500)">2000×1500</button>
                                <button class="btn btn-sm" style="padding:6px 10px; font-size:0.75rem;" onclick="window.App.setPageSize(2480, 3508)">A4 (2480×3508)</button>
                            </div>
                        </div>

                        <div style="margin-bottom:15px;">
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Custom Size</label>
                            <div style="display:flex; gap:8px; align-items:end;">
                                <div style="flex:1;">
                                    <label style="display:block; font-size:0.7rem; color:var(--text-muted); margin-bottom:4px;">Width</label>
                                    <input type="number" id="pageWidthInput" placeholder="Width" class="opt-input" style="width:100%; padding:8px;">
                                </div>
                                <div style="font-size:1.2rem; color:#666; display:flex; align-items:center; height:36px;">×</div>
                                <div style="flex:1;">
                                    <label style="display:block; font-size:0.7rem; color:var(--text-muted); margin-bottom:4px;">Height</label>
                                    <div style="display:flex; gap:8px; align-items:end;">
                                        <input type="number" id="pageHeightInput" placeholder="Height" class="opt-input" style="width:100%; padding:8px;">
                                        <button class="btn btn-sm" style="padding:8px 12px;" onclick="window.App.setCustomPageSize()">Set</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom:15px;">
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:8px; font-weight:600;">Preview</label>
                            <div id="pageSizePreview" style="background:var(--bg); border:1px solid var(--border); border-radius:4px; height:150px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;">
                                <div id="pagePreview" style="background:#fff; box-shadow:0 0 0 1px #ddd; transition:all 0.2s; border-radius:2px;"></div>
                            </div>
                        </div>

                        <button class="btn btn-primary" style="width:100%; padding:10px;" onclick="window.App.applyPageSizeToAll()">Apply to All Pages</button>
                    </div>
                </div>
            </div>

            <!-- Box / Clipboard Panel -->
            <div class="sidebar-content" id="panelBox" style="display:none">
                <div class="control-section">
                    <button class="btn btn-primary" style="width:100%; justify-content:center; margin-bottom:10px;" onclick="window.App.captureFullPage()">Add Full Page</button>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="text" id="boxRangeInput" placeholder="Range (e.g. 1-3)" class="opt-input" style="flex:1">
                        <button class="btn btn-sm" onclick="window.App.addRangeToBox()">Add</button>
                    </div>

                    <p style="font-size:0.8rem; color:#aaa; margin-top:0;">Items in Box: <span id="boxCount">0</span></p>
                    <div id="boxList" class="box-grid"></div>
                    <button class="btn btn-sm" style="margin-top:10px; width:100%; border-color:#ef4444; color:#ef4444" onclick="window.App.clearBox()">Clear Box</button>
                </div>
                
                <div class="control-section">
                    <h4>Export Sheet</h4>
                     <p style="font-size:0.8rem; color:#aaa; margin:0 0 10px 0;">Header Tags: <span class="tag-pill" onclick="window.App.addBoxTag('{date}','header')">{date}</span> <span class="tag-pill" onclick="window.App.addBoxTag('{count}','header')">{count}</span></p>

                    <div style="margin-bottom:10px;">
                        <span style="font-size:0.8rem; color:#aaa">Columns</span>
                        <select id="boxCols" class="opt-input" style="width:100%; margin-top:4px;">
                            <option value="1">1 Column</option>
                            <option value="2" selected>2 Columns</option>
                            <option value="3">3 Columns</option>
                            <option value="4">4 Columns</option>
                        </select>
                    </div>
                    
                    <!-- Practice Space Toggle -->
                    <div style="margin-bottom:10px; background:rgba(255,255,255,0.05); padding:8px; border-radius:6px;">
                         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <span style="font-size:0.8rem; font-weight:600;">Add Practice Space</span>
                            <label class="switch" style="transform:scale(0.6)"><input type="checkbox" id="boxPracticeOn"><span class="slider-switch"></span></label>
                         </div>
                         <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:0.8rem; color:#aaa">Color</span>
                            <select id="boxPracticeColor" class="opt-input" style="flex:1">
                                <option value="white">White</option>
                                <option value="black">Black</option>
                            </select>
                         </div>
                    </div>

                    <!-- Captions Toggle -->
                    <div style="margin-bottom:10px;">
                         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <span style="font-size:0.8rem; color:#aaa">Show Captions</span>
                            <label class="switch" style="transform:scale(0.6)"><input type="checkbox" id="boxLabelsOn"><span class="slider-switch"></span></label>
                         </div>
                         <div style="margin-bottom:5px;">
                            <span style="font-size:0.8rem; color:#aaa">Position</span>
                            <select id="boxLabelsPos" class="opt-input" style="width:100%; margin-top:2px;">
                                <option value="bottom" selected>Bottom</option>
                                <option value="top">Top</option>
                            </select>
                         </div>
                         <input type="text" id="boxLabelTxt" class="opt-input" placeholder="#{seq} • Page {page}" value="#{seq} • Page {page}" style="width:100%">
                         <div style="font-size:0.7rem; color:#666; margin-top:3px;">Tags: {seq}, {page}</div>
                    </div>

                     <div style="margin-bottom:10px;">
                         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <span style="font-size:0.8rem; color:#aaa">Header</span>
                            <label class="switch" style="transform:scale(0.6)"><input type="checkbox" id="boxHeaderOn"><span class="slider-switch"></span></label>
                         </div>
                         <input type="text" id="boxHeaderTxt" class="opt-input" placeholder="Sheet Header" style="width:100%">
                    </div>
                     <div style="margin-bottom:10px;">
                         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <span style="font-size:0.8rem; color:#aaa">Footer</span>
                            <label class="switch" style="transform:scale(0.6)"><input type="checkbox" id="boxFooterOn"><span class="slider-switch"></span></label>
                         </div>
                         <input type="text" id="boxFooterTxt" class="opt-input" placeholder="Sheet Footer" style="width:100%">
                    </div>
                     <div style="margin-bottom:10px;">
                         <span style="font-size:0.8rem; color:#aaa">Export Format</span>
                         <select id="boxExportFormat" class="opt-input" style="width:100%; margin-top:2px;">
                             <option value="pdf">PDF Document</option>
                             <option value="zip">ZIP Archive (Images)</option>
                         </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <span style="font-size:0.8rem; color:#aaa">Highest Quality</span>
                                <span style="font-size:0.65rem; color:#666; display:block;">PNG @ full resolution (larger files)</span>
                            </div>
                            <label class="switch" style="transform:scale(0.7)"><input type="checkbox" id="boxHiQuality"><span class="slider-switch"></span></label>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="window.App.generateBoxImage()">Export Sheet</button>
                </div>
            </div>

            <!-- Trace Panel -->
            <div class="sidebar-content" id="panelDebug" style="display:none">
                <div class="control-section">
                    <h4>Session Trace</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <div style="background:#0a0a0a; border:1px solid #222; padding:10px; border-radius:4px;">
                            <span style="font-size:0.6rem; color:#888; text-transform:uppercase; font-weight:700; display:block; margin-bottom:4px;">Sync Status</span>
                            <span id="debugStatus" style="font-size:0.8rem; font-weight:800; color:#fff;">--</span>
                        </div>
                        <div style="background:#0a0a0a; border:1px solid #222; padding:10px; border-radius:4px;">
                            <span style="font-size:0.6rem; color:#888; text-transform:uppercase; font-weight:700; display:block; margin-bottom:4px;">Current Page</span>
                            <span id="debugPageIdx" style="font-size:0.8rem; font-weight:800; color:#fff;">--</span>
                        </div>
                    </div>
                    
                    <div style="background:#0a0a0a; border:1px solid #222; padding:12px; border-radius:4px; margin-top:8px;">
                        <span style="font-size:0.6rem; color:#888; text-transform:uppercase; font-weight:700; display:block; margin-bottom:6px;">Room Identity</span>
                        <div id="debugRoomId" style="font-size:0.7rem; font-family:monospace; color:#fff; word-break:break-all; line-height:1.4;">--</div>
                    </div>

                    <div style="background:#0a0a0a; border:1px solid #222; padding:12px; border-radius:4px; margin-top:8px;">
                        <span style="font-size:0.6rem; color:#888; text-transform:uppercase; font-weight:700; display:block; margin-bottom:6px;">User Reference</span>
                        <div id="debugUserId" style="font-size:0.7rem; font-family:monospace; color:#fff; word-break:break-all;">--</div>
                    </div>
                </div>

                <div class="control-section">
                    <h4>Object Manifest</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <div style="background:#0a0a0a; border:1px solid #222; padding:10px; border-radius:4px;">
                            <span style="font-size:0.6rem; color:#888; text-transform:uppercase; font-weight:700; display:block; margin-bottom:4px;">Local Total</span>
                            <span id="debugPageCount" style="font-size:0.8rem; font-weight:800; color:#fff;">--</span>
                        </div>
                        <div style="background:#0a0a0a; border:1px solid #222; padding:10px; border-radius:4px;">
                            <span style="font-size:0.6rem; color:#888; text-transform:uppercase; font-weight:700; display:block; margin-bottom:4px;">History Items</span>
                            <span id="debugHistoryCount" style="font-size:0.8rem; font-weight:800; color:#fff;">--</span>
                        </div>
                    </div>
                    
                    <div style="background:#0a0a0a; border:1px solid #222; padding:12px; border-radius:4px; margin-top:8px;">
                        <span style="font-size:0.6rem; color:#888; text-transform:uppercase; font-weight:700; display:block; margin-bottom:6px;">Remote Persistence</span>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:0.7rem; color:#888;">Remote Count:</span>
                            <span id="debugRemoteCount" style="font-size:0.75rem; font-weight:800; color:#fff;">--</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
                            <span style="font-size:0.7rem; color:#888;">Owner ID:</span>
                            <span id="debugRemoteOwner" style="font-size:0.6rem; font-family:monospace; color:#fff;">--</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h4>Storage Integrity</h4>
                    <div id="debugKeyCheck" style="font-size:0.65rem; color:#fff; display:grid; gap:6px; background:#000; border:1px solid #222; padding:12px; border-radius:4px;">
                        --
                    </div>
                </div>

                <div class="control-section">
                    <h4>Live Map Trace</h4>
                    <div id="debugLiveMap" style="font-size:0.65rem; font-family:monospace; color:#00ff00; max-height:180px; overflow:auto; background:#000; border:1px solid #222; padding:12px; border-radius:4px; line-height:1.5;">
                        Initializing trace...
                    </div>
                </div>

                <div class="control-section" style="margin-top:auto; overflow:hidden;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <button class="btn btn-outline" style="justify-content:center; font-size:0.7rem; padding:10px;" onclick="window.App.render()">Redraw</button>
                        <button class="btn btn-outline" style="justify-content:center; font-size:0.7rem; padding:10px;" onclick="window.LiveSync.syncHistory(); window.App.render();">Sync Now</button>
                    </div>
                    <button class="btn" style="width:100%; justify-content:center; margin-top:8px; font-size:0.7rem; padding:10px; border-color:#22c55e; color:#22c55e;" onclick="window.App.compactAllHistory()">
                        <i class="bi bi-arrow-repeat"></i> Compact History
                    </button>
                    <button class="btn btn-danger" style="width:100%; justify-content:center; margin-top:8px; font-size:0.7rem; padding:10px;" onclick="location.reload()">Force Hard Reload</button>
                </div>
            </div>

            <div class="sidebar-footer">
                <div id="presenterControls" style="display:none; margin-bottom: 8px;">
                    <button id="lockBtn" class="btn" style="width:100%; justify-content:center;" onclick="App.togglePageLock()">
                        <i class="bi bi-unlock"></i> Presenter Lock: OFF
                    </button>
                </div>
                <button class="btn" onclick="App.saveImage()">Save Image</button>
                <button class="btn btn-primary" onclick="UI.showExportModal()">Export...</button>
            </div>
        </aside>

        <main class="viewport" id="viewport">
            <div id="cursorLayer" class="cursor-layer"></div>
                <canvas id="canvas" oncontextmenu="return false;"></canvas>
            <!-- Navigation Island -->
            <div class="nav-island">
                <button class="btn btn-icon" style="border-radius:4px; background:transparent; border:none;" onclick="App.loadPage(App.state.idx-1)"><i class="bi bi-chevron-left"></i></button>
                
                <div style="display:flex; align-items:center; gap:4px; font-family:monospace; font-size:0.8rem; font-weight:700;">
                    <input type="number" id="pageInput" style="background:transparent; border:none; color:white; width:32px; text-align:right; padding:2px;" min="1">
                    <span id="pageTotal" style="color:#555;">/ 0</span>
                </div>

                <button class="btn btn-icon" style="border-radius:4px; background:transparent; border:none;" onclick="App.loadPage(App.state.idx+1)"><i class="bi bi-chevron-right"></i></button>
                
                <div style="width:1px; height:16px; background:#333;"></div>

                <!-- Zoom Controls -->
                <button class="btn btn-icon" style="border-radius:4px; background:transparent; border:none;" onclick="App.zoomOut()" title="Zoom Out (Ctrl+-)"><i class="bi bi-dash-lg" style="font-size:0.8rem"></i></button>
                <button id="zoomBtn" class="btn btn-sm" style="background:transparent; border:none; font-family:monospace; font-size:0.75rem; min-width:50px; color:#888;" onclick="App.resetZoom()" ondblclick="App.fitToScreen()" title="Click: Reset | Double-click: Fit">100%</button>
                <button class="btn btn-icon" style="border-radius:4px; background:transparent; border:none;" onclick="App.zoomIn()" title="Zoom In (Ctrl++)"><i class="bi bi-plus-lg" style="font-size:0.8rem"></i></button>
                <button class="btn btn-icon" style="border-radius:4px; background:transparent; border:none;" onclick="App.fitToScreen()" title="Fit to Screen (F)"><i class="bi bi-arrows-fullscreen" style="font-size:0.7rem"></i></button>

                <div style="width:1px; height:16px; background:#333;"></div>
                
                <button class="btn btn-icon" style="border-radius:4px; background:transparent; border:none;" onclick="App.undo()"><i class="bi bi-arrow-counterclockwise" style="font-size:0.8rem"></i></button>
            </div>
        </main>
    </div>

    <!-- Load config first for API base URL detection -->
    <script type="module" src="./scripts/config.js"></script>
    <script type="module" src="./scripts/Logger.js"></script>
    <script type="module" src="./scripts/main.js"></script>

    <script>
        // Robust Resizable Sidebar (Desktop & Mobile)
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const resizerSide = document.getElementById('resizerSide'); // Desktop
            const resizerTop = document.getElementById('resizerTop');   // Mobile

            if (!sidebar) return;

            let isResizing = false;
            let startVal = 0;   // Start X or Y
            let startSize = 0;  // Start Width or Height

            // Desktop Horizontal Resize
            if (resizerSide) {
                const handlePointerDown = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    isResizing = true;

                    const startX = e.clientX;
                    const startWidth = sidebar.getBoundingClientRect().width;

                    const handlePointerMove = (ev) => {
                        if (!isResizing) return;
                        ev.preventDefault();

                        const diff = ev.clientX - startX;
                        const newWidth = Math.max(200, Math.min(window.innerWidth * 0.6, startWidth + diff));
                        sidebar.style.width = newWidth + 'px';
                    };

                    const handlePointerUp = () => {
                        isResizing = false;
                        document.removeEventListener('pointermove', handlePointerMove);
                        document.removeEventListener('pointerup', handlePointerUp);
                        document.body.style.userSelect = '';
                        document.body.style.cursor = '';
                    };

                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'col-resize';
                    document.addEventListener('pointermove', handlePointerMove, { passive: false });
                    document.addEventListener('pointerup', handlePointerUp);
                };

                resizerSide.addEventListener('pointerdown', handlePointerDown);
            }

            // Mobile Vertical Resize
            if (resizerTop) {
                const handlePointerDown = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    isResizing = true;

                    const startY = e.clientY;
                    const startHeight = sidebar.getBoundingClientRect().height;

                    const handlePointerMove = (ev) => {
                        if (!isResizing) return;
                        ev.preventDefault();

                        const diff = startY - ev.clientY;
                        const minH = window.innerHeight * 0.2;
                        const maxH = window.innerHeight * 0.8;
                        const newHeight = Math.max(minH, Math.min(maxH, startHeight + diff));
                        sidebar.style.height = newHeight + 'px';
                    };

                    const handlePointerUp = () => {
                        isResizing = false;
                        document.removeEventListener('pointermove', handlePointerMove);
                        document.removeEventListener('pointerup', handlePointerUp);
                        document.body.style.userSelect = '';
                        document.body.style.cursor = '';
                    };

                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'row-resize';
                    document.addEventListener('pointermove', handlePointerMove, { passive: false });
                    document.addEventListener('pointerup', handlePointerUp);
                };

                resizerTop.addEventListener('pointerdown', handlePointerDown);
            }
        });
    </script>
</body>
</html> 

